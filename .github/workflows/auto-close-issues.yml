name: Auto Close Issues on Push

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - '.github/**'
      - 'docs/**'

jobs:
  close-issues:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Close Auto-Generated Issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Mendapatkan semua issue yang terbuka dengan label auto-generated
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-generated'
            });
            
            if (issues.length === 0) {
              console.log('‚úÖ No auto-generated issues to close');
              return;
            }
            
            console.log(`üîç Found ${issues.length} auto-generated issues to close`);
            
            // Menutup semua issue auto-generated
            for (const issue of issues) {
              try {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
                
                // Menambahkan komentar penutupan
                const commentBody = '## ‚úÖ Issue Closed Automatically\n\n' +
                  'This issue has been automatically closed due to a new push to the `' + context.ref.replace('refs/heads/', '') + '` branch.\n\n' +
                  '**Commit:** `' + context.payload.head_commit.id.substring(0, 7) + '`\n' +
                  '**Author:** ' + context.payload.head_commit.author.name + '\n' +
                  '**Date:** ' + new Date(context.payload.head_commit.timestamp).toLocaleString() + '\n\n' +
                  '**Reason:** New update has been pushed, making this issue outdated.\n\n' +
                  '---\n' +
                  '*This comment was automatically added by GitHub Actions.*';
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: commentBody
                });
                
                console.log(`‚úÖ Closed issue #${issue.number}: ${issue.title}`);
              } catch (error) {
                console.error(`‚ùå Failed to close issue #${issue.number}:`, error.message);
              }
            }
            
            console.log(`üéâ Successfully closed ${issues.length} auto-generated issues`);
